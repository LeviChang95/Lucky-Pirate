<!doctype html>
<html>
<head>
    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Lucky Pirate</h1>
Welcome to lucky pirate a pirate themed gambling game. Find the treasure chests filled with <b id="gold">gold</b> but avoid the <b id="skulls">skulls</b> or loose your fortune!
<br>

<div>
    <h2>Rules</h2>
    Tap the start button to begin and enter a wager. Gold pieces will be hidden amoungst the treasure chests, the total value of which will always be double your origional wager.
    Tap a chest to open it winning the gold inside. However two skulls are hidden amoungst the gold, if you tap a skull you lose the game and all the money you won.
    You can stop playing at any time using the X button.
</div>

<br>

<script type="module">

    //----------------------------------------------BASIC SETUP---------------------------------------------------------------

    //import {Text} from "node_modules/pixi.js";

    const app = new PIXI.Application();
    const w = 690;
    const h = 550;

    let crab = null;
    let pirateShip = null;
    let xButton = null;

    let totalMoneyText = null;
    const waves = [];
    const chests = [];
    let openChests = 0;
    let elapsed = 0.0;

    let totalMoneyCount = 300;
    let gameMoney = 0;

    async function setup(){
        await app.init({background:'#FFFFFF', width: w, height: h})
        document.body.appendChild(app.canvas);
    }

    async function preload(){
        await PIXI.Assets.load("images/beach.png");
        await PIXI.Assets.load("images/crab.png"); //on Freepik
        const waves = [
            { alias: 'wave0', src: "images/wave0.png" },
            { alias: 'wave1', src: "images/wave1.png" },
            { alias: 'wave2', src: "images/wave2.png" },
            { alias: 'wave3', src: "images/wave3.png" },
        ];
        await PIXI.Assets.load(waves);
        await PIXI.Assets.load("images/chestClosed.png");
        await PIXI.Assets.load("images/chestOpen.png");
        await PIXI.Assets.load("images/pirateShip.png");
        await PIXI.Assets.load("images/xButton.png");

    }

//-------------------------------------------------ADDING IMAGES----------------------------------------------------------

    export function addBeach(){
        let beach = PIXI.Sprite.from("images/beach.png");
        beach.width = w;
        beach.height = h;
        app.stage.addChild(beach);
    }

    export function addCrab(){
        crab = PIXI.Sprite.from("images/crab.png");
        app.stage.addChild(crab);
        crab.variableScale = 0.2;
        crab.y = 490;
        crab.scale.y = crab.variableScale;
    }

    export function addWaves(){
        let waveCount = w / 40;
        const waveAssets = ['wave0','wave1','wave2','wave3'];
        for (let i = 0; i < waveCount; i++) {
            let wave = PIXI.Sprite.from(waveAssets[Math.floor(Math.random()*4)]);
            wave.scale.x = 0.5;
            wave.scale.y = 0.5;
            app.stage.addChild(wave);
            wave.x = i*50;
            wave.anchor.x = 0.5;
            waves.push(wave);
        }
    }

    export function simple(){
        console.log("simple");
    }

    export function addTotalMoneyText(){
        totalMoneyText = new PIXI.Text("Total Money: " + totalMoneyCount,{fontFamily : 'Georgia', fontSize: 24, fill : 0xff1010, align : 'right'});
        totalMoneyText.x = 450;
        totalMoneyText.y = 20;
        app.stage.addChild(totalMoneyText);
    }

    export function addPirateShip(){
        pirateShip = PIXI.Sprite.from("images/pirateShip.png");
        pirateShip.interactive = true;
        pirateShip.buttonMode = true;
        pirateShip.anchor.set(0.5);
        pirateShip.x = w/2;
        pirateShip.y = 260;
        pirateShip.scale.x = 0.3;
        pirateShip.scale.y = 0.3;
        app.stage.addChild(pirateShip);
        pirateShip.on('pointerdown',event => startGame(200));
    }

    export function addXButton(){
        xButton = PIXI.Sprite.from("images/xButton.png");
        xButton.interactive = true;
        xButton.buttonMode = true;
        xButton.anchor.set(0.5);
        xButton.x = 640;
        xButton.y = 500;
        xButton.scale.x = 0.03;
        xButton.scale.y = 0.03;
        app.stage.addChild(xButton);
        xButton.on('pointerdown',event => endGame());
    }

    //-----------------------------------------------GAME----------------------------------------------------------


    export function distributeTreasure(wager){
        return [0,0,0.5*wager,0.25*wager,0.25*wager,0.75*wager,0.05*wager,0.1*wager,0.1*wager];
        // let remainingWager = wager*2;
        // for (let i = 0; i < 6; i++) {
        //     let treasure = Math.random()*(remainingWager-((7-i) * 10)) + 10;
        //     remainingWager -= treasure;
        //     treasures.push(treasure);
        // }
        // treasures.push(remainingWager);
        // treasures.push(0);
        // treasures.push(0);
    }

    export function showTreasure(chest){
        if(chest.treasure == 0){
            console.log("Show Skull");
        }else{
            let text = new PIXI.Text(chest.treasure,{fontFamily : 'Georgia', fontSize: 24, fill : 0xff1010, align : 'right'});
            text.x = chest.x - 10;
            text.y = chest.y;
            app.stage.addChild(text);
        }
    }

    export function openChest(chestContainer,chest){
        openChests ++;
        chestContainer.removeChild(chest);
        openChest =
        chestContainer.addChild();
        showTreasure(chest);

        if(chest.treasure == 0){
            gameMoney = 0;
            endGame();
            return;
        }

        gameMoney += chest.treasure;

        if(openChests == 7){
            console.log("You Win")
            endGame();
        }
    }

    export function endGame(){
        totalMoneyCount += gameMoney;
        totalMoneyText.text = totalMoneyCount;
        gameMoney = 0;
        openChests = 0;

        for (let i = 0; i < chests.length; i++) {
            console.log("test " + chests[i].treasure);
            app.stage.removeChild(chests[i]);
        }

        app.stage.removeChild(xButton);
        pirateShip.interactive = true;
        pirateShip.buttonMode = true;
    }


    export function startGame(wager){
        if(totalMoneyCount < wager){
            console.log("Not enough money")
            return;
        }
        totalMoneyCount -= wager;
        totalMoneyText.text = totalMoneyCount;

        let treasures = distributeTreasure(wager);
        let width = w/7.0;
        let height = h/7.0;
        let coordinates = [width,width*3,width*5,height,height*3,height*5];
        for (let i = 0; i < 9; i++) {
            let chestContainer = new PIXI.Container();
            let chest = PIXI.Sprite.from("images/chestClosed.png");

            chest.x = coordinates[i%3];
            chest.y = coordinates[Math.floor(i/3)+3];
            let j = (Math.floor(Math.random() * treasures.length));
            chest.treasure = treasures[j];
            treasures.splice(j,1);

            chest.anchor.x = 0.5;
            chest.anchor.y = 0.5;
            chest.scale.x = 0.05;
            chest.scale.y = 0.05;

            chest.interactive = true;
            chest.buttonMode = true;
            chest.on('pointerdown',event => openChest(chestContainer));


            chestContainer.addChild(chest);
            chests.push(chestContainer);
            app.stage.addChild(chestContainer);
            console.log("here");
        }
        pirateShip.buttonMode = false;
        pirateShip.interactive = false;
        addXButton();
    }

    const movingChests = false;
    export function positionChests(time){
        for (let i = 0; i < chests; i++) {
            chest.x += chestVectorX;
            chest.y += chestVectorY;
        }
    }


    //-------------------------------------------------ANIMATIONS------------------------------------------------------------------

    export function animateWaves(time){
        let delta = time.deltaTime;
        for (let i = 0; i < waves.length; i++) {
            waves[i].x = (elapsed/5 + 50*i) % w;
            waves[i].y = 370.0 + Math.cos(elapsed/50.0 + i) * 20.0;
        }
    }

    export function animatePirateShip(time){
        let delta = time.deltaTime;
        elapsed += delta;
        pirateShip.y = 260.0 + Math.cos(elapsed/100.0) * 10.0;
        pirateShip.rotation += Math.cos(elapsed/100.0) * 0.001;
        pirateShip.x += Math.cos(elapsed/100.0) * 0.1;
    }

    export function animateCrab(time){
        let delta = time.deltaTime;
        elapsed += delta;
        crab.x = 200.0 + Math.cos(elapsed/100.0) * 125.0
        crab.anchor.x = 0.5;
        if(((elapsed/100.0)%(2*Math.PI))<Math.PI)
            crab.scale.x = crab.variableScale;
         else
            crab.scale.x = -crab.variableScale;
    }


    (async () =>
    {
        await setup();
        await preload();
        addWaves();
        addBeach();
        addCrab();
        addPirateShip();
        addTotalMoneyText();

        app.ticker.add((time) =>
        {
            animateCrab(time);
            animateWaves(time);
            animatePirateShip(time);
            if(movingChests){
                positionChests(time);
            }
        });
    })();

</script>
</body>
</html>